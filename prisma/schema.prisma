// RecDesk AI - Database Schema
// Prisma schema for MVP (Email auto-capture, CV parsing, Candidate scoring)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// COMPANY & USER MANAGEMENT
// ============================================

model Company {
  id               String   @id @default(uuid())
  name             String
  domain           String?  @unique
  mode             CompanyMode @default(FULL_ATS)
  plan             PlanType @default(STARTER)
  stripeCustomerId String?  @unique  // Stripe customer ID
  lastActivityAt   DateTime?  // Track last user activity for smart email polling
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  users            User[]
  jobs             Job[]
  candidates       Candidate[]
  emailConnections EmailConnection[]
  subscription     Subscription?
  usageRecords     UsageRecord[]
  emailTemplates   EmailTemplate[]
  notifications    Notification[]

  @@map("companies")
}

enum CompanyMode {
  FULL_ATS
  PRE_ATS
}

enum PlanType {
  STARTER
  PROFESSIONAL
  ENTERPRISE
  PRE_ATS_SCREENING
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String?  // Optional for OAuth users
  firstName    String
  lastName     String
  role         UserRole @default(RECRUITER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // OAuth provider IDs
  googleId    String?  @unique
  microsoftId String?  @unique
  avatarUrl   String?  // Profile picture from OAuth

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  candidateNotes       CandidateNote[]
  candidateActions     CandidateAction[]
  emailsSent           EmailSent[]
  refreshTokens        RefreshToken[]
  passwordResetTokens  PasswordResetToken[]
  notifications        Notification[]

  @@index([companyId])
  @@index([googleId])
  @@index([microsoftId])
  @@map("users")
}

enum UserRole {
  ADMIN
  RECRUITER
  INTERVIEWER
  VIEWER
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
  @@map("password_reset_tokens")
}

// ============================================
// JOBS
// ============================================

model Job {
  id          String    @id @default(uuid())
  title       String
  description String?
  status      JobStatus @default(ACTIVE)

  // Requirements stored as JSONB
  requirements     Json?  // { skills: [], experienceLevel, qualifications, etc. }
  requiredSkills   String[]
  preferredSkills  String[]
  experienceLevel  ExperienceLevel @default(JUNIOR)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  candidates      Candidate[]
  candidateScores CandidateScore[]
  pipelineStages  PipelineStage[]

  @@index([companyId, status])
  @@index([companyId, createdAt])
  @@map("jobs")
}

enum JobStatus {
  DRAFT
  ACTIVE
  PAUSED
  CLOSED
}

enum ExperienceLevel {
  JUNIOR
  MID
  SENIOR
  LEAD
}

model PipelineStage {
  id         String @id @default(uuid())
  name       String
  orderIndex Int
  color      String @default("#3B82F6")
  isDefault  Boolean @default(false)

  jobId String
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  candidates CandidateStage[]

  @@index([jobId, orderIndex])
  @@map("pipeline_stages")
}

// ============================================
// CANDIDATES
// ============================================

model Candidate {
  id     String          @id @default(uuid())
  source CandidateSource @default(UPLOAD)
  status CandidateStatus @default(NEW)

  // Personal Info
  fullName     String
  email        String?
  phone        String?
  location     String?
  linkedinUrl  String?
  githubUrl    String?
  portfolioUrl String?

  // CV Files
  cvFileUrl            String
  cvFileName           String?
  cvText               String?  // Extracted text from CV
  extractionConfidence Int?     // 0-100

  // Parsed Data (JSONB)
  education      Json?
  experience     Json?
  skills         Json?
  projects       Json?
  certifications Json?
  languages      Json?

  // Scoring
  overallScore   Int?     // 0-100
  scoreBreakdown Json?    // Detailed component scores
  aiSummary      String?  // AI-generated candidate summary

  // Tags
  tags String[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  jobId String?
  job   Job?   @relation(fields: [jobId], references: [id], onDelete: SetNull)

  emailImportId String?       @unique
  emailImport   EmailImport?  @relation(fields: [emailImportId], references: [id])

  scores         CandidateScore[]
  stageHistory   CandidateStage[]
  notes          CandidateNote[]
  actions        CandidateAction[]
  emailsSent     EmailSent[]

  @@index([companyId, overallScore])
  @@index([companyId, createdAt])
  @@index([companyId, jobId])
  @@index([companyId, status])
  @@index([companyId, source])
  @@index([email])
  @@index([jobId])
  @@map("candidates")
}

enum CandidateSource {
  EMAIL
  UPLOAD
  JOB_BOARD
  REFERRAL
  MANUAL
}

enum CandidateStatus {
  NEW
  SCREENING
  SHORTLISTED
  INTERVIEWING
  OFFERED
  HIRED
  REJECTED
  WITHDRAWN
}

model CandidateScore {
  id String @id @default(uuid())

  // Scores (0-100)
  overallScore      Int
  skillsMatchScore  Int?
  experienceScore   Int?
  educationScore    Int?
  growthScore       Int?
  bonusScore        Int?

  // Explanations
  scoreExplanation Json?
  recommendation   String?

  // Metadata
  algorithmVersion String @default("v1.0")
  scoredAt         DateTime @default(now())

  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  jobId String
  job   Job    @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@unique([candidateId, jobId])
  @@map("candidate_scores")
}

model CandidateStage {
  id      String   @id @default(uuid())
  movedAt DateTime @default(now())

  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  stageId String
  stage   PipelineStage @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([stageId])
  @@map("candidate_stages")
}

model CandidateNote {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([userId])
  @@map("candidate_notes")
}

model CandidateAction {
  id        String   @id @default(uuid())
  action    String   // e.g., "moved_to_stage", "shortlisted", "rejected", "email_sent"
  details   Json?
  createdAt DateTime @default(now())

  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([candidateId, createdAt])
  @@index([userId])
  @@map("candidate_actions")
}

// ============================================
// EMAIL INTEGRATION
// ============================================

model EmailConnection {
  id            String              @id @default(uuid())
  provider      EmailProvider
  email         String
  accessToken   String              // Encrypted
  refreshToken  String?             // Encrypted
  expiresAt     DateTime?
  isActive      Boolean             @default(true)
  autoImport    Boolean             @default(true)  // Auto-import job application emails
  lastSyncAt       DateTime?
  lastHistoryId    String?             // Gmail history ID for incremental sync
  watchExpiration  DateTime?           // When the Gmail Pub/Sub watch expires (max 7 days)
  watchHistoryId   String?             // historyId returned by Gmail watch() call
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  emailImports EmailImport[]

  @@unique([companyId, email])
  @@map("email_connections")
}

enum EmailProvider {
  GMAIL
  OUTLOOK
}

model EmailImport {
  id              String            @id @default(uuid())
  messageId       String            @unique  // Email message ID from provider
  subject         String?
  senderEmail     String
  senderName      String?
  receivedAt      DateTime

  // Classification
  isJobApplication  Boolean @default(false)
  confidence        Int?    // 0-100
  detectedPosition  String?

  // Email content
  bodyText      String?
  bodyHtml      String?

  // Processing status
  status        EmailImportStatus @default(PENDING)
  processedAt   DateTime?
  errorMessage  String?
  skipReason    String?   // Reason for skipping (prefilter or AI classification)

  createdAt DateTime @default(now())

  emailConnectionId String
  emailConnection   EmailConnection @relation(fields: [emailConnectionId], references: [id], onDelete: Cascade)

  candidate Candidate?

  @@index([status, createdAt])  // For efficient cleanup queries
  @@index([emailConnectionId, status])
  @@index([emailConnectionId])
  @@map("email_imports")
}

enum EmailImportStatus {
  PENDING
  PROCESSING
  IMPORTED
  SKIPPED
  FAILED
}

// ============================================
// EMAIL COMMUNICATION
// ============================================

model EmailTemplate {
  id        String            @id @default(uuid())
  name      String
  subject   String
  body      String
  type      EmailTemplateType
  isDefault Boolean           @default(false)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([companyId, type])
  @@map("email_templates")
}

enum EmailTemplateType {
  REJECTION
  INTERVIEW_INVITE
  OFFER
  FOLLOW_UP
  CUSTOM
}

model EmailSent {
  id        String   @id @default(uuid())
  subject   String
  body      String
  sentAt    DateTime @default(now())
  openedAt  DateTime?
  clickedAt DateTime?

  candidateId String
  candidate   Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)

  sentById String
  sentBy   User   @relation(fields: [sentById], references: [id], onDelete: Cascade)

  @@index([candidateId])
  @@index([sentById])
  @@map("emails_sent")
}

// ============================================
// BILLING & SUBSCRIPTIONS
// ============================================

model SubscriptionPlan {
  id               String   @id @default(uuid())
  name             String   // "Free Trial", "Starter", "Professional", "Enterprise"
  stripePriceId    String?  @unique  // Stripe price ID (null for free trial)
  monthlyPrice     Int      // Price in cents (0 for free trial)
  annualPrice      Int?     // Annual price in cents (with discount)
  cvLimit          Int      // CVs per month (-1 for unlimited)
  userLimit        Int      // Team members (-1 for unlimited)
  aiCallLimit      Int      @default(-1)  // AI calls per month (-1 for unlimited)
  emailSentLimit   Int      @default(-1)  // Emails sent per month (-1 for unlimited)
  emailImportLimit Int      @default(-1)  // Emails imported per month (-1 for unlimited)
  features         Json     // Feature flags { emailIntegration: true, ... }
  isActive         Boolean  @default(true)
  sortOrder        Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  subscriptions Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id                   String             @id @default(uuid())
  stripeSubscriptionId String?            @unique  // Null for free trial
  status               SubscriptionStatus @default(TRIALING)
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  trialEndsAt          DateTime?          // For free trial tracking
  gracePeriodEndsAt    DateTime?          // Set when payment fails, null otherwise
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  companyId String  @unique
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  planId String
  plan   SubscriptionPlan @relation(fields: [planId], references: [id])

  @@map("subscriptions")
}

enum SubscriptionStatus {
  TRIALING
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
  EXPIRED  // Subscription period has ended without renewal
}

model UsageRecord {
  id          String    @id @default(uuid())
  type        UsageType
  count       Int       @default(1)
  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime  @default(now())

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, type, periodStart])
  @@map("usage_records")
}

enum UsageType {
  CV_PROCESSED
  AI_PARSING_CALL
  AI_SCORING_CALL
  EMAIL_SENT
  EMAIL_IMPORTED
}

model Invoice {
  id              String        @id @default(uuid())
  stripeInvoiceId String        @unique
  amountDue       Int           // In cents
  amountPaid      Int           // In cents
  currency        String        @default("usd")
  status          InvoiceStatus
  invoicePdf      String?       // URL to PDF
  hostedInvoiceUrl String?      // Stripe hosted invoice URL
  periodStart     DateTime
  periodEnd       DateTime
  paidAt          DateTime?
  createdAt       DateTime      @default(now())

  companyId String
  
  @@index([companyId])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

// ============================================
// NOTIFICATIONS
// ============================================

enum NotificationType {
  EMAIL_IMPORT_COMPLETE
  CV_PROCESSING_COMPLETE
  BULK_UPLOAD_COMPLETE
  USAGE_WARNING_80
  USAGE_WARNING_90
  USAGE_LIMIT_REACHED
  // Trial and subscription notifications
  TRIAL_EXPIRING_SOON     // 3 days before trial ends
  TRIAL_EXPIRING_TOMORROW // 1 day before trial ends
  TRIAL_EXPIRED           // Trial has expired
  SUBSCRIPTION_EXPIRED    // Subscription period has ended
  PAYMENT_FAILED_WARNING  // Payment failed, grace period started
}

model Notification {
  id        String           @id @default(uuid())
  type      NotificationType
  title     String
  message   String
  metadata  Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  userId    String?
  user      User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([companyId, isRead, createdAt])
  @@map("notifications")
}

model UsageAlertTracker {
  id               String   @id @default(uuid())
  companyId        String
  periodStart      DateTime
  periodEnd        DateTime
  threshold80Sent  Boolean  @default(false)
  threshold90Sent  Boolean  @default(false)
  threshold100Sent Boolean  @default(false)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([companyId, periodStart])
  @@map("usage_alert_trackers")
}
